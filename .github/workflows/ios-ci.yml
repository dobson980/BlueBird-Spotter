name: iOS CI

on:
  push:
    branches:
      - main
      - 'codex/**'
  pull_request:

jobs:
  build-and-unit-test:
    timeout-minutes: 60
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Latest Installed Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest

      - name: Show Xcode Version
        run: xcodebuild -version

      - name: Ensure iOS Simulator Runtime Is Available
        run: |
          set -euo pipefail

          # Some runner images occasionally start without usable iOS simulators.
          # If no iPhone simulator is available, request the iOS platform runtime.
          if ! xcrun simctl list devices available | grep -q "iPhone"; then
            echo "No available iPhone simulators detected. Downloading iOS platform runtime..."
            xcodebuild -downloadPlatform iOS
          fi

          # If runtime exists but no iPhone simulator device was created, create one.
          if ! xcrun simctl list devices available | grep -q "iPhone"; then
            runtime_id="$(
              xcrun simctl list runtimes available | \
              awk -F ' - ' '/iOS/ && /SimRuntime\\.iOS/ { print $2; exit }'
            )"
            device_type_id="$(
              xcrun simctl list devicetypes | \
              awk -F '[()]' '
                /iPhone 16/ { print $2; foundPreferred = 1; exit }
                /iPhone/ && !fallback { fallback = $2 }
                END {
                  if (!foundPreferred && fallback != "") {
                    print fallback
                  }
                }
              '
            )"

            if [ -n "${runtime_id}" ] && [ -n "${device_type_id}" ]; then
              echo "Creating fallback simulator with runtime ${runtime_id} and device type ${device_type_id}..."
              xcrun simctl create "BlueBird Spotter CI iPhone" "${device_type_id}" "${runtime_id}" || true
            fi
          fi

          echo "Available simulator devices:"
          xcrun simctl list devices available

      - name: Select iOS 26 Simulator
        run: |
          set -euo pipefail

          simulator_id="$(
            xcrun simctl list devices available | \
            awk '
              /^-- iOS 26/ { in_iOS26 = 1; next }
              /^-- / { in_iOS26 = 0 }
              in_iOS26 && /iPhone 17 \(/ {
                if (match($0, /\(([A-F0-9-]+)\)/)) {
                  print substr($0, RSTART + 1, RLENGTH - 2);
                  foundPreferred = 1;
                  exit;
                }
              }
              in_iOS26 && /iPhone/ && !fallback {
                if (match($0, /\(([A-F0-9-]+)\)/)) {
                  fallback = substr($0, RSTART + 1, RLENGTH - 2);
                }
              }
              END {
                if (!foundPreferred && fallback != "") {
                  print fallback;
                }
              }
            '
          )"

          if [ -z "${simulator_id}" ]; then
            echo "No iOS 26 iPhone simulator was found."
            xcrun simctl list devices available
            exit 1
          fi

          echo "SIMULATOR_ID=${simulator_id}" >> "$GITHUB_ENV"
          echo "Using simulator id: ${simulator_id}"

      - name: Run Unit Tests
        timeout-minutes: 25
        run: |
          set -euo pipefail

          # Emit a periodic heartbeat so long-running compile/test phases remain
          # visible in GitHub logs instead of appearing frozen.
          (
            while true; do
              echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] Unit test job still running..."
              sleep 60
            done
          ) &
          heartbeat_pid=$!
          trap 'kill "${heartbeat_pid}" 2>/dev/null || true' EXIT

          xcodebuild \
            -scheme "BlueBird Spotter UnitTests" \
            -destination "platform=iOS Simulator,id=$SIMULATOR_ID,arch=arm64" \
            -destination-timeout 120 \
            -only-testing:"BlueBird SpotterTests" \
            -skip-testing:"BlueBird SpotterUITests" \
            -derivedDataPath "$RUNNER_TEMP/BlueBirdSpotter-DerivedData" \
            -resultBundlePath "$RUNNER_TEMP/BlueBirdSpotter-UnitTests.xcresult" \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            ENABLE_PREVIEWS=NO \
            test

      - name: Upload Unit Test Result Bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: BlueBirdSpotter-UnitTests-xcresult
          path: ${{ runner.temp }}/BlueBirdSpotter-UnitTests.xcresult
          if-no-files-found: ignore
