name: iOS CI

on:
  push:
    branches:
      - main
      - 'codex/**'
  pull_request:

jobs:
  build-and-unit-test:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.4
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"

      - name: Show Xcode Version
        run: xcodebuild -version

      - name: Ensure iOS Simulator Runtime Is Available
        run: |
          set -euo pipefail

          # Some runner images occasionally start without usable iOS simulators.
          # If no iPhone simulator is available, request the iOS platform runtime.
          if ! xcrun simctl list devices available | grep -q "iPhone"; then
            echo "No available iPhone simulators detected. Downloading iOS platform runtime..."
            xcodebuild -downloadPlatform iOS
          fi

          # If runtime exists but no iPhone simulator device was created, create one.
          if ! xcrun simctl list devices available | grep -q "iPhone"; then
            runtime_id="$(
              xcrun simctl list runtimes available | \
              awk -F ' - ' '/iOS/ && /SimRuntime\\.iOS/ { print $2; exit }'
            )"
            device_type_id="$(
              xcrun simctl list devicetypes | \
              awk -F '[()]' '
                /iPhone 16/ { print $2; foundPreferred = 1; exit }
                /iPhone/ && !fallback { fallback = $2 }
                END {
                  if (!foundPreferred && fallback != "") {
                    print fallback
                  }
                }
              '
            )"

            if [ -n "${runtime_id}" ] && [ -n "${device_type_id}" ]; then
              echo "Creating fallback simulator with runtime ${runtime_id} and device type ${device_type_id}..."
              xcrun simctl create "BlueBird Spotter CI iPhone" "${device_type_id}" "${runtime_id}" || true
            fi
          fi

          echo "Available simulator devices:"
          xcrun simctl list devices available

      - name: Select Simulator Destination
        run: |
          set -euo pipefail

          destination="$(
            xcodebuild -scheme "BlueBird Spotter" -showdestinations 2>/dev/null | \
            awk '
              /platform:iOS Simulator/ && /name:iPhone/ {
                os = ""; name = "";
                if (match($0, /OS:[^,]*/)) {
                  os = substr($0, RSTART + 3, RLENGTH - 3);
                  gsub(/^ +| +$/, "", os);
                }
                if (match($0, /name:[^}]*/)) {
                  name = substr($0, RSTART + 5, RLENGTH - 5);
                  gsub(/^ +| +$/, "", name);
                }
                if (os != "" && name != "") {
                  destination = sprintf("platform=iOS Simulator,OS=%s,name=%s", os, name);
                  if ($0 ~ /name:iPhone 17/) {
                    print destination;
                    foundPreferred = 1;
                    exit;
                  }
                  if (fallback == "") {
                    fallback = destination;
                  }
                }
              }
              END {
                if (!foundPreferred && fallback != "") {
                  print fallback;
                }
              }
            '
          )"

          if [ -z "${destination}" ]; then
            echo "No iPhone simulator destination was found for this scheme."
            xcodebuild -scheme "BlueBird Spotter" -showdestinations
            exit 1
          fi

          echo "SIMULATOR_DESTINATION=${destination}" >> "$GITHUB_ENV"
          echo "Using simulator destination: ${destination}"

      - name: Build App (Simulator)
        run: |
          xcodebuild \
            -scheme "BlueBird Spotter" \
            -destination "$SIMULATOR_DESTINATION" \
            -derivedDataPath "$RUNNER_TEMP/BlueBirdSpotter-DerivedData" \
            CODE_SIGNING_ALLOWED=NO \
            build-for-testing

      - name: Run Unit Tests
        run: |
          xcodebuild \
            -scheme "BlueBird Spotter" \
            -destination "$SIMULATOR_DESTINATION" \
            -only-testing:"BlueBird SpotterTests" \
            -derivedDataPath "$RUNNER_TEMP/BlueBirdSpotter-DerivedData" \
            CODE_SIGNING_ALLOWED=NO \
            test-without-building
